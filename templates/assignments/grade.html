{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Grade Assignment</h1>
            <h4 class="text-muted">{{ assignment.title }}</h4>
        </div>
        <a href="{{ url_for('assignment.view_assignment', id=assignment.id) }}" 
           class="btn btn-outline-secondary">
            Back to Assignment
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" 
                               id="needs-grading-tab" 
                               data-bs-toggle="tab" 
                               href="#needs-grading" 
                               role="tab">
                                Needs Grading 
                                <span class="badge bg-warning">
                                    {{ progress_entries|selectattr('needs_grading')|list|length }}
                                </span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" 
                               id="all-submissions-tab" 
                               data-bs-toggle="tab" 
                               href="#all-submissions" 
                               role="tab">
                                All Submissions
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" 
                             id="needs-grading" 
                             role="tabpanel">
                            {% set needs_grading = progress_entries|selectattr('needs_grading')|list %}
                            {% if needs_grading %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Submitted</th>
                                            <th>Auto Score</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for progress in needs_grading %}
                                        <tr>
                                            <td>{{ progress.student.name }}</td>
                                            <td>{{ progress.last_attempt.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>{{ progress.auto_score }}%</td>
                                            <td>
                                                <button type="button"
                                                        class="btn btn-primary btn-sm"
                                                        onclick="loadSubmission({{ progress.id }})">
                                                    Grade
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                No submissions need grading at this time.
                            </div>
                            {% endif %}
                        </div>

                        <div class="tab-pane fade" 
                             id="all-submissions" 
                             role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Status</th>
                                            <th>Auto Score</th>
                                            <th>Final Score</th>
                                            <th>Graded By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for progress in progress_entries %}
                                        <tr>
                                            <td>{{ progress.student.name }}</td>
                                            <td>
                                                {% if progress.completed %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% elif progress.started %}
                                                    <span class="badge bg-warning">In Progress</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Not Started</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ progress.auto_score }}%</td>
                                            <td>
                                                {% if progress.score is not none %}
                                                    {{ progress.score }}%
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if progress.graded_by %}
                                                    {{ progress.graded_by.name }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button"
                                                        class="btn btn-outline-primary btn-sm"
                                                        onclick="loadSubmission({{ progress.id }})">
                                                    View/Grade
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Grading Summary</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Total Submissions
                            <span class="badge bg-primary rounded-pill">
                                {{ progress_entries|selectattr('started')|list|length }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Needs Grading
                            <span class="badge bg-warning rounded-pill">
                                {{ progress_entries|selectattr('needs_grading')|list|length }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Graded
                            <span class="badge bg-success rounded-pill">
                                {{ progress_entries|selectattr('is_graded')|list|length }}
                            </span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6>Class Statistics</h6>
                        <p class="mb-1">Average Score: 
                            {% set scores = progress_entries|selectattr('score', 'defined')|map(attribute='score')|list %}
                            {% if scores %}
                                {{ "%.1f"|format(scores|sum / scores|length) }}%
                            {% else %}
                                -
                            {% endif %}
                        </p>
                        <p class="mb-1">Completion Rate: 
                            {% set completion_rate = (progress_entries|selectattr('completed')|list|length / 
                                                    progress_entries|length * 100) %}
                            {{ "%.1f"|format(completion_rate) }}%
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grading Modal -->
<div class="modal fade" id="gradingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Grade Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="submissionContent">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadSubmission(progressId) {
    const modal = new bootstrap.Modal(document.getElementById('gradingModal'));
    const contentDiv = document.getElementById('submissionContent');
    
    // Show modal with loading state
    modal.show();
    contentDiv.innerHTML = 'Loading...';
    
    // Fetch submission details
    fetch(`/assignments/submission/${progressId}`)
        .then(response => response.json())
        .then(data => {
            contentDiv.innerHTML = buildSubmissionHTML(data);
            initializeGradingHandlers(progressId);
        })
        .catch(error => {
            console.error('Error:', error);
            contentDiv.innerHTML = 'Error loading submission.';
        });
}

function buildSubmissionHTML(data) {
    // Build the HTML for the submission details
    // This will be implemented based on your submission data structure
    return `
        <div class="submission-details">
            <h6>Student: ${data.student_name}</h6>
            <div class="mb-3">
                <label class="form-label">Score</label>
                <input type="number" class="form-control" id="score" 
                       value="${data.auto_score}" min="0" max="100">
            </div>
            <div class="mb-3">
                <label class="form-label">Comments</label>
                <textarea class="form-control" id="comments" rows="3">${data.comments || ''}</textarea>
            </div>
            <button onclick="submitGrade(${data.progress_id})" 
                    class="btn btn-primary">
                Save Grade
            </button>
        </div>
        <div class="mt-4">
            <h6>Work Shown:</h6>
            <div class="work-content">
                ${data.work_content}
            </div>
        </div>
    `;
}

function submitGrade(progressId) {
    const score = document.getElementById('score').value;
    const comments = document.getElementById('comments').value;
    
    fetch(`/assignments/${progressId}/grade`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ score, comments }),
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            throw new Error('Failed to save grade');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving grade');
    });
}
</script>
{% endblock %}