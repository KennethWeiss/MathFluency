{% extends "base.html" %}

{% block title %}Practice - Math Fluency{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Main Content -->
    <h2>Math Practice</h2>
    
    <!-- Operation Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Choose Operation</h4>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-operation="addition">Addition</button>
                        <button type="button" class="btn btn-outline-primary" data-operation="multiplication">Multiplication</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Level Selection -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Choose Level</h4>
                </div>
                <div class="card-body">
                    <!-- Addition Levels -->
                    <div id="addition-levels">
                        <select class="form-select" id="addition-select">
                            <option value="1">Level 1: Adding 1 to single digit</option>
                            <option value="2">Level 2: Adding 2 to single digit</option>
                            <option value="3">Level 3: Make 10</option>
                            <option value="4">Level 4: Add single digit to double digit</option>
                            <option value="5">Level 5: Add double digit to double digit</option>
                        </select>
                    </div>
                    
                    <!-- Multiplication Levels (initially hidden) -->
                    <div id="multiplication-levels" style="display: none;">
                        <select class="form-select" id="multiplication-select">
                            <option value="0">× 0</option>
                            <option value="1">× 1</option>
                            <option value="2">× 2</option>
                            <option value="5">× 5</option>
                            <option value="10">× 10</option>
                            <option value="11">× 11</option>
                            <option value="3">× 3</option>
                            <option value="4">× 4</option>
                            <option value="6">× 6</option>
                            <option value="8">× 8</option>
                            <option value="7">× 7</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Problem Display Area -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4>Practice Problem</h4>
                </div>
                <div class="card-body text-center">
                    <div id="problem-display" class="text-center mb-4">
                        <h2 id="current-problem" class="display-4 mb-4"></h2>
                        <div id="answer-hint" class="alert alert-info" style="display: none;">
                            <strong>Hint:</strong> The answer is <span id="correct-answer"></span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="number" id="answer-input" class="form-control form-control-lg text-center" placeholder="Enter your answer">
                        <input type="hidden" id="correct-answer-hidden">
                    </div>
                    
                    <div class="btn-group">
                        <button id="new-problem" class="btn btn-primary btn-lg">New Problem</button>
                        <button id="check-answer" class="btn btn-success btn-lg">Check Answer</button>
                    </div>
                    
                    <div id="feedback" class="mt-3">
                        <!-- Feedback will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentOperation = 'addition';
    let problemStartTime = null;
    let currentProblem = null;
    let wrongAttempts = 0;

    // Problem generation functions
    function generateAdditionProblem(level) {
        level = parseInt(level);
        problemStartTime = Date.now();  // Record start time
        if (level === 1) {  // Adding 1 to single digit
            const num = Math.floor(Math.random() * 10);
            return { problem: `${num} + 1`, answer: num + 1 };
        } else if (level === 2) {  // Adding 2 to single digit
            const num = Math.floor(Math.random() * 10);
            return { problem: `${num} + 2`, answer: num + 2 };
        } else if (level === 3) {  // Making sums equal to 10
            const num = Math.floor(Math.random() * 9) + 1;
            return { problem: `${num} + ____ = 10`, answer: 10 - num };
        } else if (level === 4) {  // Single digit to double digit
            const num1 = Math.floor(Math.random() * 90) + 10;
            const num2 = Math.floor(Math.random() * 9) + 1;
            return { problem: `${num1} + ${num2}`, answer: num1 + num2 };
        } else if (level === 5) {  // Double digit to double digit
            const num1 = Math.floor(Math.random() * 90) + 10;
            const num2 = Math.floor(Math.random() * 90) + 10;
            return { problem: `${num1} + ${num2}`, answer: num1 + num2 };
        }
    }

    function generateMultiplicationProblem(level) {
        level = parseInt(level);
        problemStartTime = Date.now();  // Record start time
        if (level >= 0 && level <= 12) {
            const num = Math.floor(Math.random() * 13);
            return { problem: `${num} × ${level}`, answer: num * level };
        }
    }

    function getNewProblem() {
        const level = currentOperation === 'addition' 
            ? document.getElementById('addition-select').value 
            : document.getElementById('multiplication-select').value;
        
        const problem = currentOperation === 'addition' 
            ? generateAdditionProblem(level)
            : generateMultiplicationProblem(level);

        displayProblem({ problem: problem.problem, answer: problem.answer, show_answer: false });
        document.getElementById('correct-answer-hidden').value = problem.answer;
        document.getElementById('answer-input').value = '';
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('answer-input').focus();
        wrongAttempts = 0;
    }

    function displayProblem(data) {
        document.getElementById('current-problem').textContent = data.problem;
        if (data.show_answer) {
            document.getElementById('correct-answer').textContent = data.answer;
            document.getElementById('answer-hint').style.display = 'block';
        } else {
            document.getElementById('answer-hint').style.display = 'none';
        }
        currentProblem = data;
    }

    // Operation selection
    document.querySelectorAll('[data-operation]').forEach(button => {
        button.addEventListener('click', function() {
            // Update buttons
            document.querySelectorAll('[data-operation]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update operation and level display
            currentOperation = this.dataset.operation;
            document.getElementById('addition-levels').style.display = currentOperation === 'addition' ? 'block' : 'none';
            document.getElementById('multiplication-levels').style.display = currentOperation === 'multiplication' ? 'block' : 'none';
            
            // Get new problem for the selected operation
            getNewProblem();
        });
    });

    // Get new problem
    document.getElementById('new-problem').addEventListener('click', getNewProblem);

    // Check answer
    document.getElementById('check-answer').addEventListener('click', function() {
        const userAnswer = document.getElementById('answer-input').value;
        const correctAnswer = document.getElementById('correct-answer-hidden').value;
        const timeTaken = (Date.now() - problemStartTime) / 1000;  // Convert to seconds
        
        // Check answer on frontend
        const isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
        const feedback = document.getElementById('feedback');
        
        // Record the attempt
        fetch('/record_attempt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                operation: currentOperation,
                level: currentOperation === 'addition' 
                    ? document.getElementById('addition-select').value 
                    : document.getElementById('multiplication-select').value,
                problem: document.getElementById('current-problem').textContent,
                userAnswer: parseInt(userAnswer),
                correctAnswer: parseInt(correctAnswer),
                isCorrect: isCorrect,
                timeTaken: timeTaken
            })
        });
        
        if (isCorrect) {
            feedback.innerHTML = '<div class="alert alert-success">Correct! Great job!</div>';
            getNewProblem();
            setTimeout(() => feedback.innerHTML = '', 1000);
        } else {
            wrongAttempts++;
            if (wrongAttempts >= 3) {
                displayProblem({ problem: currentProblem.problem, answer: currentProblem.answer, show_answer: true });
            } else {
                feedback.innerHTML = '<div class="alert alert-danger">Not quite. Try again!</div>';
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
            }
        }
    });

    // Allow Enter key to submit answer
    document.getElementById('answer-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('check-answer').click();
        }
    });

    // Initialize first problem
    getNewProblem();
</script>
{% endblock %}
